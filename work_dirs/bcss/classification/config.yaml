model:
    backbone:
        config: conch_vit
        stride:
            - 4
            - 2
            - 2
            - 1

    n_ratio: 0.5
    num_prototypes_per_class: 1
    prototype_feature_dim: 512

    # SegFormer-guided structural distillation
    segformer_guidance:
        enable: true
        backbone: mit_b1
        checkpoint: null
        layers: [2]
        train_clip_visual: false
        use_structure_adapter: true

    # Text prompts for each class
    text_prompts:
        - Tumor (TUM) regions consist of malignant epithelial cells characterized by pleomorphic, hyperchromatic nuclei, loss of glandular structure, and frequent mitotic figures, representing the core cancerous lesions in breast tissue.
        - Stroma (STR) comprises the surrounding connective tissue, including fibroblasts and collagen fibers, often appearing as pink fibrous structures and sometimes showing desmoplastic reactions to tumor invasion.
        - Lymphocyte (LYM) regions contain dense clusters of small immune cells with dark, round nuclei and minimal cytoplasm, reflecting the host immune response within the tumor microenvironment.
        - Necrosis (NEC) represents areas of dead or dying tissue with pale, structureless eosinophilic regions, nuclear debris, and “ghost” cell remnants, typically associated with aggressive tumor growth and poor vascularization.

clip:
    model_name: conch_ViT-B-16
    checkpoint_path: ./checkpoints/conch/pytorch_model.bin
    cache_dir: ./checkpoints/conch
    hf_hub: null
    hf_token: null
    force_image_size: 224
    proj_contrast: true
    freeze: true

dataset:
    name: bcss
    train_root: ./data/BCSS-WSSS/train
    val_root: ./data/BCSS-WSSS/
    cls_num_classes: 4
    input_size:
        - 224
        - 224

work_dir:
    ckpt_dir: checkpoints
    pred_dir: predictions
    train_log_dir: train_log

train:
    samples_per_gpu: 10
    epoch: 2
    warmup_iters: 0
    pretrained: true

    # Only keep main cls + structural distillation
    l1: 0.0
    l2: 0.0
    l3: 0.0
    l4: 1.0
    l5: 0.0
    l_proto_text: 0.0
    l_proto_temp: 0.07
    lambda_j: 0.0
    l_fuse: 0.0
    l_struct: 1.5
    diversity: {}
    memory_bank_size: 0
    mask_adapter_alpha: 0.5
    merge_train: mean
    merge_test: max

optimizer:
    type: AdamW
    learning_rate: 0.00002
    betas:
        - 0.9
        - 0.999
    weight_decay: 0.001

scheduler:
    warmup_iter: 0
    warmup_ratio: 1.0e-06
    power: 1.0
