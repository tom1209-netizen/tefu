model:
  backbone:
    config: conch_vit
    stride:
    - 4
    - 2
    - 2
    - 1
  
  n_ratio: 0.5
  num_prototypes_per_class: 3
  prototype_feature_dim: 512

  # Text fusion settings
  enable_text_fusion: true
  fusion_dim: 512

  # Text prompt settings
  learnable_text_prompt: true
  prompt_init_scale: 0.02
  prototype_init_mode: text_learnable
  prototype_text_noise_std: 0.02

  # Learnable context
  use_ctx_prompt: false
  ctx_prompt_len: 8
  ctx_class_specific: true

  # SegFormer-guided structural distillation
  segformer_guidance:
    enable: true
    backbone: mit_b1
    checkpoint: null  
    layers: [0, 1, 2, 3]
    train_clip_visual: false
    use_structure_adapter: true

  # CoCoOp (conditional prompts)
  enable_cocoop: true
  cocoop_n_ctx: 8
  cocoop_ctx_init: "Histopathology image showing"
  cocoop_class_names: null

  # Text prompts for each class
  text_prompts:
  - Tumor (TUM) regions consist of malignant epithelial cells characterized by pleomorphic, hyperchromatic nuclei, loss of glandular structure, and frequent mitotic figures, representing the core cancerous lesions in breast tissue.
  - Stroma (STR) comprises the surrounding connective tissue, including fibroblasts and collagen fibers, often appearing as pink fibrous structures and sometimes showing desmoplastic reactions to tumor invasion.
  - Lymphocyte (LYM) regions contain dense clusters of small immune cells with dark, round nuclei and minimal cytoplasm, reflecting the host immune response within the tumor microenvironment.
  - Necrosis (NEC) represents areas of dead or dying tissue with pale, structureless eosinophilic regions, nuclear debris, and “ghost” cell remnants, typically associated with aggressive tumor growth and poor vascularization.

clip:
  model_name: conch_ViT-B-16
  checkpoint_path: ./checkpoints/conch/pytorch_model.bin
  cache_dir: ./checkpoints/conch
  hf_hub: null
  hf_token: null
  force_image_size: 448
  proj_contrast: true
  freeze: true

dataset:
  name: bcss
  train_root: ./data/BCSS-WSSS/train
  val_root: ./data/BCSS-WSSS/
  cls_num_classes: 4
  input_size:
  - 224
  - 224

work_dir:
  ckpt_dir: checkpoints
  pred_dir: predictions
  train_log_dir: train_log

train:
  samples_per_gpu: 10
  epoch: 8
  warmup_iters: 2000
  pretrained: true

  # Classification losses for multi-scale features
  l1: 0.0
  l2: 0.1
  l3: 1.0
  l4: 1.0

  # Contrastive loss
  l5: 0.2

  # Prototype losses
  l_proto_text: 0.1
  l_proto_temp: 0.07

  # Fusion and diversity losses 
  lambda_j: 0.25
  l_fuse: 1.0
  l_struct: 1.0

  # Diversity loss settings
  diversity:
    repulsion_weight: 0.5
    coverage_weight: 0.2
    omega_min_mass: 0.05
    spatial_weight: 0.1
    spatial_jeffreys_weight: 0.05

  # Memory bank for contrastive learning
  memory_bank_size: 2048

  # Mask settings
  mask_adapter_alpha: 0.5
  merge_train: mean
  merge_test: max

optimizer:
  type: AdamW
  learning_rate: 0.00005
  betas:
  - 0.9
  - 0.999
  weight_decay: 0.001

scheduler:
  warmup_iter: 0
  warmup_ratio: 1.0e-06
  power: 1.0
